name: "Ex 1 Promote (Stage)"
on:
  workflow_dispatch:

jobs:
  get-deployment:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.get-deployment-action.outputs.sha }}
      ref: ${{ steps.get-deployment-action.outputs.ref }}
    steps:
      - uses: tgrnwd/get-deployment@v1
        id: get-deployment-action
        with:
          token: ${{ secrets.GITHUB_TOKEN  }}
          environment: ex1-dev

  stage:
    runs-on: ubuntu-latest
    environment: ex1-stage
    needs: get-deployment
    steps:
      - run: | 
          echo "${{ needs.get-deployment.outputs.ref }}"
          echo "${{ needs.get-deployment.outputs.sha }}"

      - uses: cardinalby/git-get-release-action@v1
        id: get-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN  }}
        with:
          commitSha: ${{ needs.get-deployment.outputs.sha }}

      - run: | 
          echo "${{ steps.get-release.outputs.tag_name }}"
          echo "${{ steps.get-release.outputs.id }}"

      - name: Download release asset
        id: download-release-asset
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: tags/${{ steps.get-release.outputs.tag_name }}
          file: readme.txt
          target: ./readme.txt
          token: ${{ secrets.GITHUB_TOKEN  }}

      - run: |
          cat readme.txt

      - name: Deploy
        run: |
          echo "Deploying to ex1-stage"